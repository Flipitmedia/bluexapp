<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Bluex Automator - Herramienta de Conversi√≥n</title>
  <meta name="description" content="Convierte exportaciones de Shopify al formato de carga masiva de Bluexpress" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">

  <!-- Librer√≠as externas (defer para asegurar carga antes de uso interactivo) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>

  <style>
    :root{
      --primary:#1e3c72;--secondary:#2a5298;--success:#28a745;--danger:#dc3545;--warning:#ffc107;
      --light:#f8f9fa;--dark:#333;--border:#e9ecef;--border-radius:8px;--shadow:0 4px 6px rgba(0,0,0,.1);
      --transition:all .3s ease
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);min-height:100vh;color:var(--dark);line-height:1.6}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .app-wrapper{background:#fff;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden;animation:fadeIn .6s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .header{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);color:#fff;padding:40px;text-align:center;position:relative}
    .header::before{content:'';position:absolute;inset:0;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>')}
    .header-content{position:relative;z-index:1}
    .header h1{font-size:3rem;font-weight:300;margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,.2)}
    .header p{font-size:1.2rem;opacity:.9;margin-bottom:20px}
    .version-badge{display:inline-block;background:rgba(255,255,255,.2);padding:8px 16px;border-radius:20px;font-size:.9rem;font-weight:500}
    .main-content{padding:40px}
    .auth-section{max-width:400px;margin:0 auto 40px;text-align:center}
    .auth-form{background:var(--light);padding:30px;border-radius:var(--border-radius);border:2px solid var(--border)}
    .auth-form h3{color:var(--primary);margin-bottom:12px;font-size:1.5rem}
    .auth-form p{margin-bottom:12px}
    .app-section{display:none}
    .app-section.active{display:block;animation:slideIn .4s ease-out}
    @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
    .section{background:var(--light);margin-bottom:30px;padding:30px;border-radius:var(--border-radius);border-left:4px solid var(--primary);box-shadow:var(--shadow);transition:var(--transition)}
    .section:hover{transform:translateY(-2px);box-shadow:0 8px 15px rgba(0,0,0,.1)}
    .section h3{color:var(--primary);margin-bottom:20px;font-size:1.4rem;display:flex;align-items:center;gap:10px}
    .form-group{margin-bottom:20px}
    .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;align-items:end}
    label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark);font-size:.95rem}
    input,select,textarea{width:100%;padding:12px 16px;border:2px solid var(--border);border-radius:var(--border-radius);font-size:14px;font-family:inherit;transition:var(--transition);background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,60,114,.1)}
    .file-input-wrapper{position:relative;display:block}
    .file-input{position:absolute;left:-9999px;opacity:0}
    .file-input-label{display:block;padding:20px;background:#fff;border:2px dashed var(--border);border-radius:var(--border-radius);text-align:center;cursor:pointer;transition:var(--transition);min-height:80px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px}
    .file-input-label:hover{background:var(--light);border-color:var(--primary);transform:translateY(-1px)}
    .file-input-label.has-file{background:linear-gradient(135deg,#d4edda 0%,#c8e6c9 100%);border-color:var(--success);color:#155724;border-style:solid;border-width:3px;transform:scale(1.02);box-shadow:0 4px 12px rgba(40,167,69,.2)}
    .file-icon{font-size:2rem;opacity:.6}
    .file-input-label.processing{background:linear-gradient(135deg,#fff3cd 0%,#ffe8a1 100%);border-color:var(--warning);color:#856404;animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.8}}
    .file-info{margin-top:10px;padding:10px;background:#fff;border-radius:4px;border:1px solid #e0e0e0;display:none;animation:slideDown .3s ease-out}
    .file-info.visible{display:block}
    .file-info-item{display:flex;justify-content:space-between;padding:4px 0;font-size:.9rem}
    .file-info-label{color:#666;font-weight:500}
    .file-info-value{color:var(--primary);font-weight:600}
    .checkbox-wrapper{display:flex;align-items:center;gap:12px;margin:20px 0;padding:15px;background:#fff;border-radius:var(--border-radius);border:1px solid var(--border)}
    .checkbox-wrapper input[type="checkbox"]{width:auto;margin:0;transform:scale(1.2)}
    textarea{resize:vertical;min-height:120px;font-family:'Monaco','Menlo','Ubuntu Mono',monospace;font-size:13px}
    .btn{padding:15px 30px;border:none;border-radius:var(--border-radius);font-size:16px;font-weight:600;cursor:pointer;transition:var(--transition);font-family:inherit;text-decoration:none;display:inline-flex;align-items:center;gap:8px;position:relative;overflow:hidden}
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}
    .btn:hover::before{left:100%}
    .btn-primary{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);color:#fff;box-shadow:var(--shadow)}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 15px rgba(30,60,114,.3)}
    .btn-secondary{background:#6c757d;color:#fff}
    .btn-secondary:hover{background:#545b62}
    .btn-success{background:var(--success);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .progress-container{margin:30px 0;display:none}
    .progress-container.active{display:block}
    .progress{width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden;position:relative}
    .progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));width:0%;transition:width .3s ease;position:relative}
    .progress-bar::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 1.5s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .progress-text{text-align:center;margin-top:10px;font-weight:500;color:var(--primary)}
    .alert{padding:16px 20px;border-radius:var(--border-radius);margin-bottom:20px;border-left:4px solid;animation:slideDown .3s ease-out}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .alert-success{background:#d4edda;color:#155724;border-color:var(--success)}
    .alert-error{background:#f8d7da;color:#721c24;border-color:var(--danger)}
    .alert-warning{background:#fff3cd;color:#856404;border-color:var(--warning)}
    .alert-info{background:#d1ecf1;color:#0c5460;border-color:#bee5eb}
    .button-group{display:flex;gap:15px;justify-content:center;flex-wrap:wrap;margin-top:30px}
    .mapping-hint{font-size:.85rem;color:#6c757d;margin-top:8px;font-style:italic;background:#fff;padding:10px;border-radius:4px;border:1px solid #f0f0f0}
    .feature-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:30px 0}
    .feature-card{background:#fff;padding:25px;border-radius:var(--border-radius);box-shadow:var(--shadow);text-align:center;transition:var(--transition)}
    .feature-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .feature-icon{font-size:3rem;margin-bottom:15px;display:block}
    .logout-btn{position:absolute;top:20px;right:20px;background:rgba(255,255,255,.2);color:#fff;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-size:.9rem;transition:var(--transition);z-index:2}
    .logout-btn:hover{background:rgba(255,255,255,.3)}
    @media (max-width:768px){
      .container{padding:10px}
      .header{padding:30px 20px}
      .header h1{font-size:2.5rem}
      .main-content{padding:20px}
      .form-row{grid-template-columns:1fr}
      .button-group{flex-direction:column}
      .btn{width:100%;justify-content:center}
      .logout-btn{position:static;margin:10px auto;display:block;width:fit-content}
    }
    .loading{opacity:.7;pointer-events:none}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="container">
    <div class="app-wrapper">
      <div class="header">
        <button class="logout-btn hidden" id="logoutBtn" type="button" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        <div class="header-content">
          <h1>üöÄ Bluex Automator</h1>
          <p>Herramienta profesional para convertir pedidos de Shopify al formato de Bluexpress</p>
          <span class="version-badge">v2.1 - Web Edition</span>
        </div>
      </div>

      <div class="main-content">
        <!-- Autenticaci√≥n -->
        <div class="auth-section" id="authSection">
          <div class="auth-form">
            <h3>üîê Acceso Seguro</h3>
            <p>Esta herramienta requiere autorizaci√≥n para su uso.</p>
            <div class="form-group">
              <input type="password" id="accessPassword" placeholder="C√≥digo de acceso" autocomplete="current-password" />
            </div>
            <button class="btn btn-primary" id="authBtn" type="button" onclick="authenticate()">üîì Ingresar</button>
            <div id="authError" class="alert alert-error hidden" role="alert" aria-live="polite">
              C√≥digo de acceso incorrecto
            </div>
          </div>
        </div>

        <!-- Aplicaci√≥n -->
        <div class="app-section" id="appSection">
          <div id="alerts"></div>

          <div class="section">
            <h3>üí° Instrucciones</h3>
            <div class="feature-grid">
              <div class="feature-card">
                <span class="feature-icon">üì§</span>
                <h4>1. Exportar desde Shopify</h4>
                <p>Ve a Admin ‚Üí Pedidos ‚Üí Exportar. Incluye detalles de productos y env√≠o.</p>
              </div>
              <div class="feature-card">
                <span class="feature-icon">‚öôÔ∏è</span>
                <h4>2. Configurar Opciones</h4>
                <p>Ajusta valores por defecto y mapeos de regi√≥n/comuna.</p>
              </div>
              <div class="feature-card">
                <span class="feature-icon">üìä</span>
                <h4>3. Generar Archivo</h4>
                <p>Descarga el Excel listo para Bluexpress.</p>
              </div>
            </div>
          </div>

          <!-- Archivos -->
          <div class="section">
            <h3>üìÅ Archivos</h3>
            <div class="form-group">
              <label for="csvFile">Exportaci√≥n de Shopify (CSV) *</label>
              <div class="file-input-wrapper">
                <input type="file" id="csvFile" class="file-input" accept=".csv" required />
                <label for="csvFile" class="file-input-label">
                  <span class="file-icon">üìÑ</span>
                  <span class="file-text">Seleccionar archivo CSV de Shopify</span>
                  <small>Arrastra el archivo aqu√≠ o haz clic para seleccionar</small>
                </label>
                <div class="file-info" id="csvFileInfo">
                  <div class="file-info-item"><span class="file-info-label">Nombre:</span><span class="file-info-value" id="csvFileName">-</span></div>
                  <div class="file-info-item"><span class="file-info-label">Tama√±o:</span><span class="file-info-value" id="csvFileSize">-</span></div>
                  <div class="file-info-item"><span class="file-info-label">Filas detectadas:</span><span class="file-info-value" id="csvRowCount">-</span></div>
                </div>
              </div>
            </div>

            <div class="checkbox-wrapper">
              <input type="checkbox" id="useTemplate" />
              <label for="useTemplate">üìã Usar plantilla oficial de Bluexpress (opcional - preserva formato exacto)</label>
            </div>

            <div class="form-group hidden" id="templateGroup">
              <label for="templateFile">Plantilla de Bluexpress (XLSX)</label>
              <div class="file-input-wrapper">
                <input type="file" id="templateFile" class="file-input" accept=".xlsx" />
                <label for="templateFile" class="file-input-label">
                  <span class="file-icon">üìä</span>
                  <span class="file-text">Seleccionar plantilla oficial</span>
                  <small>Archivo .xlsx descargado de Bluexpress</small>
                </label>
                <div class="file-info" id="templateFileInfo">
                  <div class="file-info-item"><span class="file-info-label">Nombre:</span><span class="file-info-value" id="templateFileName">-</span></div>
                  <div class="file-info-item"><span class="file-info-label">Tama√±o:</span><span class="file-info-value" id="templateFileSize">-</span></div>
                  <div class="file-info-item"><span class="file-info-label">Estado:</span><span class="file-info-value" id="templateStatus">-</span></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Configuraci√≥n -->
          <div class="section">
            <h3>‚öôÔ∏è Configuraci√≥n</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="valorCol">üí∞ Valor del contenido desde:</label>
                <select id="valorCol">
                  <option value="Subtotal">Subtotal</option>
                  <option value="Total">Total</option>
                </select>
              </div>
              <div class="form-group">
                <label for="prefijo">üìû Prefijo telef√≥nico (c√≥digo pa√≠s):</label>
                <input type="text" id="prefijo" placeholder="56" value="56" maxlength="4" />
              </div>
              <div class="form-group">
                <label for="maxDesc">üìù M√°ximo caracteres en descripci√≥n:</label>
                <input type="number" id="maxDesc" value="180" min="50" max="500" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="tipoEntrega">üöö Tipo de entrega por defecto:</label>
                <select id="tipoEntrega">
                  <option value="Domicilio">Domicilio</option>
                  <option value="Sucursal">Sucursal</option>
                </select>
              </div>
              <div class="form-group">
                <label for="garantia">üõ°Ô∏è Garant√≠a por defecto:</label>
                <select id="garantia">
                  <option value="No">No</option>
                  <option value="S√≠">S√≠</option>
                </select>
              </div>
              <div class="form-group">
                <label for="tamano">üì¶ Tama√±o por defecto:</label>
                <select id="tamano">
                  <option value="XS">XS</option>
                  <option value="S">S</option>
                  <option value="M" selected>M</option>
                  <option value="L">L</option>
                  <option value="XL">XL</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Normalizaci√≥n -->
          <div class="section">
            <h3>üó∫Ô∏è Normalizaci√≥n de Datos</h3>
            <p style="margin-bottom:20px;color:#666;">Configura mapeos para estandarizar nombres de regiones y comunas seg√∫n los requerimientos de Bluexpress.</p>
            <div class="form-row">
              <div class="form-group">
                <label for="mapRegion">üèõÔ∏è Normalizaci√≥n de Regiones:</label>
                <textarea id="mapRegion" placeholder="Regi√≥n Metropolitana=RM&#10;Valpara√≠so=V Regi√≥n&#10;Biob√≠o=VIII Regi√≥n&#10;Araucan√≠a=IX Regi√≥n"></textarea>
                <div class="mapping-hint">Una por l√≠nea, formato: <strong>clave=valor</strong><br />Ejemplo: "Regi√≥n Metropolitana=RM"</div>
              </div>
              <div class="form-group">
                <label for="mapComuna">üèòÔ∏è Normalizaci√≥n de Comunas:</label>
                <textarea id="mapComuna" placeholder="Las Condes=Las Condes&#10;Providencia=Providencia&#10;Santiago Centro=Santiago&#10;Maip√∫=Maipu"></textarea>
                <div class="mapping-hint">Una por l√≠nea, formato: <strong>clave=valor</strong><br />Ejemplo: "Santiago Centro=Santiago"</div>
              </div>
            </div>
          </div>

          <!-- Progreso -->
          <div class="progress-container" id="progressContainer">
            <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
            <div class="progress-text" id="progressText">Procesando...</div>
          </div>

          <!-- Acciones -->
          <div class="button-group">
            <button class="btn btn-primary" id="generateBtn" type="button">üöÄ Generar Archivo Bluexpress</button>
            <button class="btn btn-secondary" id="saveConfigBtn" type="button">üíæ Guardar Configuraci√≥n</button>
            <button class="btn btn-secondary" id="loadConfigBtn" type="button">üìÇ Cargar Configuraci√≥n</button>
            <button class="btn btn-secondary" type="button" onclick="resetForm()">üîÑ Reiniciar Formulario</button>
          </div>

          <div class="section" style="margin-top:40px;text-align:center;border-left:none;background:#fff;">
            <p style="color:#666;margin:0;">
              <strong>Bluex Automator v2.1</strong> ‚Ä¢ Optimiza el flujo de trabajo con Bluexpress<br />
              <small>Todos los datos se procesan localmente en tu navegador. Ninguna informaci√≥n se env√≠a a servidores externos.</small>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // 1) Configuraci√≥n b√°sica
    // =========================
    const ACCESS_PASSWORD = 'bluex'; // CAMBIAR ESTA CONTRASE√ëA EN PRODUCCI√ìN
    const SESSION_KEY = 'bluex_session_active';

    let appConfig = {
      valor_contenido_col: 'Subtotal',
      telefono_prefijo_pais: '56',
      defaults: { 'Tipo Entrega*':'Domicilio','Garant√≠a*':'No','Tama√±o*':'M' },
      max_desc_len: 180,
      normalize: { 'Regi√≥n*': {}, 'Comuna*': {} }
    };

    const BLUEX_COLUMNS = [
      "N¬∞","Nombre*","Apellido*","Telefono*","Correo*","Tipo Entrega*","Regi√≥n*","Comuna*",
      "Nombre Calle*","N¬∞ Domicilio *","Dpto / Oficina","Referencia Ayuda","Descripci√≥n Contenido*",
      "Valor Contenido*","Garant√≠a*","N¬∞ Boleta / Factura","Tama√±o*"
    ];

    let originalTemplateWorkbook = null;
    let elements = {};

    // =========================
    // 2) Bootstrap de la app
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      initializeElements();
      setupEventListeners();
      checkAuthentication();
      safeLoadConfigurationOnStart();
    });

    function initializeElements(){
      elements = {
        authSection: document.getElementById('authSection'),
        appSection: document.getElementById('appSection'),
        accessPassword: document.getElementById('accessPassword'),
        authError: document.getElementById('authError'),
        logoutBtn: document.getElementById('logoutBtn'),
        authBtn: document.getElementById('authBtn'),
        csvFile: document.getElementById('csvFile'),
        templateFile: document.getElementById('templateFile'),
        useTemplate: document.getElementById('useTemplate'),
        templateGroup: document.getElementById('templateGroup'),
        generateBtn: document.getElementById('generateBtn'),
        saveConfigBtn: document.getElementById('saveConfigBtn'),
        loadConfigBtn: document.getElementById('loadConfigBtn'),
        alerts: document.getElementById('alerts'),
        progressContainer: document.getElementById('progressContainer'),
        progressBar: document.getElementById('progressBar'),
        progressText: document.getElementById('progressText'),
        csvFileInfo: document.getElementById('csvFileInfo'),
        templateFileInfo: document.getElementById('templateFileInfo')
      };
    }

    function setupEventListeners(){
      // Autenticaci√≥n: Enter y bot√≥n
      elements.accessPassword.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){
          e.preventDefault();
          authenticate();
        }
      });

      // Archivos
      elements.csvFile.addEventListener('change', handleCSVFileSelect);
      elements.templateFile.addEventListener('change', handleTemplateFileSelect);
      elements.useTemplate.addEventListener('change', toggleTemplate);

      // Botones principales
      elements.generateBtn.addEventListener('click', generateFile);
      elements.saveConfigBtn.addEventListener('click', saveConfiguration);
      elements.loadConfigBtn.addEventListener('click', loadConfiguration);

      // Drag & Drop bonito
      setupDragDrop();
    }

    // =========================
    // 3) Autenticaci√≥n
    // =========================
    function authenticate(){
      const password = (elements.accessPassword.value || '').trim();
      if(password === ACCESS_PASSWORD){
        sessionStorage.setItem(SESSION_KEY, 'true');
        elements.authSection.classList.add('hidden');
        elements.appSection.classList.add('active');
        elements.logoutBtn.classList.remove('hidden');
        elements.authError.classList.add('hidden');
        showAlert('¬°Acceso autorizado! Bienvenido al Bluex Automator.', 'success');
      }else{
        elements.authError.classList.remove('hidden');
        elements.accessPassword.value = '';
        elements.accessPassword.focus();
      }
    }
    function logout(){
      sessionStorage.removeItem(SESSION_KEY);
      elements.authSection.classList.remove('hidden');
      elements.appSection.classList.remove('active');
      elements.logoutBtn.classList.add('hidden');
      elements.accessPassword.value = '';
      clearAlerts();
      resetProgress();
      originalTemplateWorkbook = null;
    }
    function checkAuthentication(){
      const isAuthenticated = sessionStorage.getItem(SESSION_KEY) === 'true';
      if(isAuthenticated){
        elements.authSection.classList.add('hidden');
        elements.appSection.classList.add('active');
        elements.logoutBtn.classList.remove('hidden');
        showAlert('Sesi√≥n restaurada.', 'info');
      }
    }
    // Exponer funciones para onclick inline
    window.authenticate = authenticate;
    window.logout = logout;
    window.resetForm = resetForm;

    // =========================
    // 4) Utilidades UI
    // =========================
    function showAlert(message, type='success'){
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      const icon = type==='success' ? '‚úÖ' : type==='error' ? '‚ùå' : type==='warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      alert.innerHTML = `<strong>${icon}</strong> ${message}`;
      elements.alerts.appendChild(alert);
      setTimeout(() => { alert.remove?.(); }, 5000);
      alert.scrollIntoView({behavior:'smooth',block:'nearest'});
    }
    function clearAlerts(){ elements.alerts.innerHTML=''; }
    function updateProgress(percent, text='Procesando...'){
      elements.progressContainer.classList.add('active');
      elements.progressBar.style.width = `${percent}%`;
      elements.progressText.textContent = text;
      if(percent >= 100){
        setTimeout(resetProgress, 1500);
      }
    }
    function resetProgress(){
      elements.progressContainer.classList.remove('active');
      elements.progressBar.style.width = '0%';
      elements.progressText.textContent = 'Procesando...';
    }

    // =========================
    // 5) Drag & Drop archivos
    // =========================
    function setupDragDrop(){
      const fileLabels = document.querySelectorAll('.file-input-label');
      fileLabels.forEach(label => {
        ['dragenter','dragover','dragleave','drop'].forEach(ev => label.addEventListener(ev, preventDefaults, false));
        ['dragenter','dragover'].forEach(ev => label.addEventListener(ev, highlight, false));
        ['dragleave','drop'].forEach(ev => label.addEventListener(ev, unhighlight, false));
        label.addEventListener('drop', handleDrop, false);
      });
    }
    function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }
    function highlight(e){ const l = e.target.closest('.file-input-label'); if(l){ l.style.background = '#e3f2fd'; l.style.borderColor = '#1976d2'; } }
    function unhighlight(e){ const l = e.target.closest('.file-input-label'); if(l){ l.style.background = ''; l.style.borderColor = ''; } }
    function handleDrop(e){
      const label = e.target.closest('.file-input-label');
      if(!label) return;
      const fileInput = document.querySelector(`#${label.getAttribute('for')}`);
      const files = e.dataTransfer.files;
      if(files?.length > 0){
        fileInput.files = files;
        if(fileInput.id === 'csvFile'){ handleCSVFileSelect({ target:fileInput }); }
        else { handleTemplateFileSelect({ target:fileInput }); }
      }
    }
    function formatFileSize(bytes){
      if(bytes === 0) return '0 Bytes';
      const k=1024, sizes=['Bytes','KB','MB','GB'];
      const i = Math.floor(Math.log(bytes)/Math.log(k));
      return Math.round((bytes/Math.pow(k,i))*100)/100 + ' ' + sizes[i];
    }

    // =========================
    // 6) Manejo de archivos
    // =========================
    async function handleCSVFileSelect(e){
      const file = e.target.files?.[0];
      const label = document.querySelector(`label[for="${e.target.id}"]`);
      const fileText = label?.querySelector('.file-text');
      if(!label || !fileText) return;

      if(file){
        label.classList.add('processing'); fileText.textContent='‚è≥ Procesando archivo...';
        try{
          if(!file.name.toLowerCase().endsWith('.csv')){
            showAlert('Por favor selecciona un archivo CSV v√°lido.', 'warning');
            label.classList.remove('processing','has-file');
            fileText.textContent='Seleccionar archivo CSV de Shopify';
            return;
          }
          const content = await file.text();
          // Conteo r√°pido de filas
          const full = Papa.parse(content,{ header:true, skipEmptyLines:true });
          const rowCount = full.data.length;

          document.getElementById('csvFileName').textContent = file.name;
          document.getElementById('csvFileSize').textContent = formatFileSize(file.size);
          document.getElementById('csvRowCount').textContent = `${rowCount} pedidos`;
          elements.csvFileInfo.classList.add('visible');

          setTimeout(() => {
            label.classList.remove('processing');
            label.classList.add('has-file');
            fileText.innerHTML = `<strong>‚úÖ ${file.name}</strong>`;
            showAlert(`Archivo CSV cargado: ${rowCount} registros`, 'success');
          }, 300);
        }catch(err){
          console.error(err);
          showAlert('Error al procesar el archivo CSV', 'error');
          label.classList.remove('processing','has-file');
          fileText.textContent='Seleccionar archivo CSV de Shopify';
          elements.csvFileInfo.classList.remove('visible');
        }
      }else{
        fileText.textContent='Seleccionar archivo CSV de Shopify';
        label.classList.remove('has-file','processing');
        elements.csvFileInfo.classList.remove('visible');
      }
    }

    async function handleTemplateFileSelect(e){
      const file = e.target.files?.[0];
      const label = document.querySelector(`label[for="${e.target.id}"]`);
      const fileText = label?.querySelector('.file-text');
      if(!label || !fileText) return;

      if(file){
        label.classList.add('processing'); fileText.textContent='‚è≥ Analizando plantilla...';
        try{
          if(!file.name.toLowerCase().endsWith('.xlsx')){
            showAlert('Por favor selecciona un archivo Excel (.xlsx) v√°lido.', 'warning');
            label.classList.remove('processing','has-file');
            fileText.textContent='Seleccionar plantilla oficial';
            return;
          }
          const arrayBuffer = await file.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type:'array', cellStyles:true, cellFormulas:true, cellDates:true, cellNF:true, sheetStubs:true });
          originalTemplateWorkbook = workbook;

          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          let hasRequiredColumns = false;

          for(let row=0; row<10; row++){
            let found=0;
            for(let col=0; col<30; col++){
              const cell = worksheet[XLSX.utils.encode_cell({r:row,c:col})];
              if(cell && cell.v && BLUEX_COLUMNS.includes(String(cell.v).trim())) found++;
            }
            if(found >= 10){ hasRequiredColumns = true; break; }
          }

          document.getElementById('templateFileName').textContent = file.name;
          document.getElementById('templateFileSize').textContent = formatFileSize(file.size);
          document.getElementById('templateStatus').textContent = hasRequiredColumns ? '‚úÖ Plantilla v√°lida' : '‚ö†Ô∏è Verificar formato';
          elements.templateFileInfo.classList.add('visible');

          setTimeout(() => {
            label.classList.remove('processing');
            label.classList.add('has-file');
            fileText.innerHTML = `<strong>‚úÖ ${file.name}</strong>`;
            showAlert(hasRequiredColumns
              ? 'Plantilla de Bluexpress cargada y validada.'
              : 'Plantilla cargada. No se detectaron todas las columnas esperadas.', hasRequiredColumns ? 'success' : 'warning');
          }, 300);
        }catch(err){
          console.error(err);
          showAlert('Error al procesar la plantilla Excel', 'error');
          label.classList.remove('processing','has-file');
          fileText.textContent='Seleccionar plantilla oficial';
          elements.templateFileInfo.classList.remove('visible');
          originalTemplateWorkbook = null;
        }
      }else{
        fileText.textContent='Seleccionar plantilla oficial';
        label.classList.remove('has-file','processing');
        elements.templateFileInfo.classList.remove('visible');
        originalTemplateWorkbook = null;
      }
    }

    function toggleTemplate(){
      const isChecked = elements.useTemplate.checked;
      elements.templateGroup.classList.toggle('hidden', !isChecked);
      if(isChecked){ showAlert('üìã Se preservar√° √≠ntegramente el formato de la plantilla oficial.', 'info'); }
    }

    // =========================
    // 7) Utilidades de datos
    // =========================
    function cleanDigitsOnly(str){ if(!str) return ''; return String(str).replace(/\D/g,''); }
    function splitFullName(fullName){
      if(!fullName || String(fullName).trim()===''){ return ['-','-']; }
      const parts = String(fullName).trim().split(/\s+/);
      if(parts.length === 1){ return [parts[0],'-']; }
      return [parts[0], parts.slice(1).join(' ')];
    }
    function extractStreetAndNumber(address){
      if(!address) return ['',''];
      const addr = String(address).trim();
      const match = addr.match(/^(.*?)[\s,]+(\d+[A-Za-z\-]?)\s*$/);
      if(match){ return [match[1].trim(), match[2].trim()]; }
      const tokens = addr.split(/\s+/);
      if(tokens.length>0 && /\d/.test(tokens[tokens.length-1])) return [tokens.slice(0,-1).join(' '), tokens[tokens.length-1]];
      return [addr,''];
    }
    function pickFirstValid(row, ...fields){
      for(const f of fields){ if(row[f] && String(row[f]).trim()!==''){ return row[f]; } }
      return '';
    }
    function buildProductDescription(orderItems, maxLength){
      const items=[];
      for(const item of orderItems){
        let quantity = item['Lineitem quantity'] ?? 1;
        quantity = parseInt(quantity) || 1;
        const productName = String(item['Lineitem name']||'').trim();
        if(productName) items.push(`x${quantity} ${productName}`);
      }
      const description = items.length>0 ? items.join(' | ') : 'Productos de ecommerce';
      return description.substring(0, maxLength);
    }
    function parseNormalizationMapping(text){
      const mapping={}; if(!text) return mapping;
      for(const raw of text.split('\n')){
        const line = raw.trim(); if(!line || line.startsWith('#')) continue;
        const idx = line.indexOf('='); if(idx === -1) continue;
        const key = line.slice(0,idx).trim(); const val = line.slice(idx+1).trim();
        if(key) mapping[key]=val;
      }
      return mapping;
    }
    function normalizeValue(value, mapping){ if(!mapping || !value) return value; const key = String(value).trim(); return mapping[key] ?? value; }

    function convertShopifyToBluex(shopifyData, config){
      const processedOrders=[]; const orderGroups={};
      for(const row of shopifyData){
        const orderNum = row['Name'];
        if(!orderGroups[orderNum]) orderGroups[orderNum]=[];
        orderGroups[orderNum].push(row);
      }
      let orderCounter=1;
      for(const [orderNumber, orderItems] of Object.entries(orderGroups)){
        const firstItem = orderItems[0] || {};

        const fullName = pickFirstValid(firstItem,'Shipping Name','Billing Name');
        const [firstName,lastName] = splitFullName(fullName);

        let phone = pickFirstValid(firstItem,'Shipping Phone','Phone');
        phone = cleanDigitsOnly(phone);
        const countryPrefix = String(config.telefono_prefijo_pais||'').trim();
        if(countryPrefix && phone && !phone.startsWith(countryPrefix)){
          phone = countryPrefix + phone;
        }

        const email = pickFirstValid(firstItem,'Email');
        let region = pickFirstValid(firstItem,'Shipping Province Name','Shipping Province');
        let city   = pickFirstValid(firstItem,'Shipping City');
        const address1 = pickFirstValid(firstItem,'Shipping Address1','Shipping Street');
        const address2 = pickFirstValid(firstItem,'Shipping Address2');
        const [streetName, streetNumber] = extractStreetAndNumber(address1);
        const notes = pickFirstValid(firstItem,'Notes','Note Attributes');

        const productDescription = buildProductDescription(orderItems, config.max_desc_len);

        const valueColumn = config.valor_contenido_col;
        let orderValue = pickFirstValid(firstItem, valueColumn);
        try{ orderValue = parseFloat(String(orderValue).replace(/[$,]/g,'').trim()) || ''; }
        catch(_e){ orderValue=''; }

        region = normalizeValue(region, config.normalize['Regi√≥n*']);
        city   = normalizeValue(city,   config.normalize['Comuna*']);

        const bluexRecord = {
          'N¬∞': orderCounter++,
          'Nombre*': firstName,
          'Apellido*': lastName,
          'Telefono*': phone,
          'Correo*': email,
          'Tipo Entrega*': config.defaults['Tipo Entrega*'],
          'Regi√≥n*': region,
          'Comuna*': city,
          'Nombre Calle*': streetName,
          'N¬∞ Domicilio *': streetNumber,
          'Dpto / Oficina': address2,
          'Referencia Ayuda': notes,
          'Descripci√≥n Contenido*': productDescription,
          'Valor Contenido*': orderValue,
          'Garant√≠a*': config.defaults['Garant√≠a*'],
          'N¬∞ Boleta / Factura': orderNumber,
          'Tama√±o*': config.defaults['Tama√±o*']
        };
        processedOrders.push(bluexRecord);
      }
      return processedOrders;
    }

    // =========================
    // 8) Configuraci√≥n (guardar/cargar)
    // =========================
    function getConfigFromUI(){
      return {
        valor_contenido_col: document.getElementById('valorCol').value,
        telefono_prefijo_pais: document.getElementById('prefijo').value,
        defaults: {
          'Tipo Entrega*': document.getElementById('tipoEntrega').value,
          'Garant√≠a*': document.getElementById('garantia').value,
          'Tama√±o*': document.getElementById('tamano').value
        },
        max_desc_len: parseInt(document.getElementById('maxDesc').value) || 180,
        normalize: {
          'Regi√≥n*': parseNormalizationMapping(document.getElementById('mapRegion').value),
          'Comuna*': parseNormalizationMapping(document.getElementById('mapComuna').value)
        }
      };
    }
    function setUIFromConfig(cfg){
      document.getElementById('valorCol').value = cfg.valor_contenido_col || 'Subtotal';
      document.getElementById('prefijo').value = cfg.telefono_prefijo_pais || '56';
      document.getElementById('maxDesc').value = cfg.max_desc_len || 180;
      document.getElementById('tipoEntrega').value = (cfg.defaults && cfg.defaults['Tipo Entrega*']) || 'Domicilio';
      document.getElementById('garantia').value = (cfg.defaults && cfg.defaults['Garant√≠a*']) || 'No';
      document.getElementById('tamano').value   = (cfg.defaults && cfg.defaults['Tama√±o*'])   || 'M';

      // reconstruir textos de normalizaci√≥n
      const regMap = cfg.normalize?.['Regi√≥n*'] || {};
      const comMap = cfg.normalize?.['Comuna*'] || {};
      document.getElementById('mapRegion').value = Object.entries(regMap).map(([k,v])=>`${k}=${v}`).join('\n');
      document.getElementById('mapComuna').value = Object.entries(comMap).map(([k,v])=>`${k}=${v}`).join('\n');
    }
    function saveConfiguration(){
      // sincronizar desde UI antes de guardar
      appConfig = getConfigFromUI();
      localStorage.setItem('bluex_config', JSON.stringify(appConfig));
      showAlert('Configuraci√≥n guardada en este navegador.', 'success');
    }
    function loadConfiguration(){
      const raw = localStorage.getItem('bluex_config');
      if(!raw){ showAlert('No hay configuraci√≥n guardada a√∫n.', 'info'); return; }
      try{
        const cfg = JSON.parse(raw);
        appConfig = cfg;
        setUIFromConfig(cfg);
        showAlert('Configuraci√≥n cargada.', 'success');
      }catch(e){
        console.error(e);
        showAlert('No se pudo cargar la configuraci√≥n guardada.', 'error');
      }
    }
    function safeLoadConfigurationOnStart(){
      try{
        const raw = localStorage.getItem('bluex_config');
        if(raw){
          const cfg = JSON.parse(raw);
          appConfig = cfg;
          setUIFromConfig(cfg);
        }
      }catch(_e){ /* sin ruido */ }
    }

    // =========================
    // 9) Generaci√≥n de archivo
    // =========================
    async function generateFile(){
      try{
        if(!elements.csvFile.files?.[0]){
          showAlert('Debes seleccionar un archivo CSV de Shopify', 'error');
          return;
        }
        if(elements.useTemplate.checked && !elements.templateFile.files?.[0]){
          showAlert('Debes seleccionar la plantilla de Bluexpress', 'error');
          return;
        }

        elements.generateBtn.disabled = true;
        elements.generateBtn.classList.add('loading');

        updateProgress(10,'Leyendo configuraci√≥n...');
        appConfig = getConfigFromUI();

        updateProgress(30,'Procesando archivo CSV...');
        const csvFile = elements.csvFile.files[0];
        const csvContent = await csvFile.text();

        updateProgress(50,'Convirtiendo datos...');
        const parseResult = Papa.parse(csvContent,{ header:true, skipEmptyLines:true, dynamicTyping:true, transformHeader:h=>h.trim() });
        if(parseResult.errors?.length){ console.warn('Advertencias CSV:', parseResult.errors); }
        const shopifyData = parseResult.data;
        const bluexData = convertShopifyToBluex(shopifyData, appConfig);

        updateProgress(70,'Generando archivo Excel...');
        let workbook;

        if(elements.useTemplate.checked && originalTemplateWorkbook){
          updateProgress(75,'Preservando formato de plantilla...');

          workbook = XLSX.utils.book_new();
          for(const sheetName of originalTemplateWorkbook.SheetNames){
            const originalSheet = originalTemplateWorkbook.Sheets[sheetName];
            const newSheet = JSON.parse(JSON.stringify(originalSheet));

            if(sheetName === originalTemplateWorkbook.SheetNames[0]){
              // buscar columnas en fila 5 (0-based r=4)
              const columnMapping = {};
              for(let col=0; col<50; col++){
                const cell = newSheet[XLSX.utils.encode_cell({r:4,c:col})];
                if(cell && cell.v && BLUEX_COLUMNS.includes(String(cell.v).trim())){
                  columnMapping[String(cell.v).trim()] = col;
                }
              }
              const startDataRow = 5; // fila siguiente
              // limpiar celdas de datos manteniendo formato
              for(let row=startDataRow; row<startDataRow+20000; row++){
                for(const col of Object.values(columnMapping)){
                  const addr = XLSX.utils.encode_cell({r:row,c:col});
                  if(newSheet[addr]){
                    const oc = newSheet[addr];
                    newSheet[addr] = { s:oc.s, z:oc.z, v:'', t:'s' };
                  }
                }
              }
              // insertar datos
              bluexData.forEach((record, idx) => {
                const row = startDataRow + idx;
                for(const [colName, val] of Object.entries(record)){
                  if(columnMapping[colName] !== undefined){
                    const addr = XLSX.utils.encode_cell({r:row,c:columnMapping[colName]});
                    const oc = newSheet[addr] || {};
                    newSheet[addr] = { v:val, t: (typeof val==='number'?'n':'s'), s:oc.s, z:oc.z };
                  }
                }
              });
              // actualizar rango de la hoja
              const ref = newSheet['!ref'] ? XLSX.utils.decode_range(newSheet['!ref']) : {s:{r:0,c:0},e:{r:0,c:0}};
              const lastRow = startDataRow + bluexData.length;
              ref.e.r = Math.max(ref.e.r, lastRow);
              newSheet['!ref'] = XLSX.utils.encode_range(ref);
            }
            XLSX.utils.book_append_sheet(workbook, newSheet, sheetName);
          }
          if(originalTemplateWorkbook.Props){ workbook.Props = originalTemplateWorkbook.Props; }
          if(originalTemplateWorkbook.Custprops){ workbook.Custprops = originalTemplateWorkbook.Custprops; }
          showAlert('üìã Formato de plantilla preservado √≠ntegramente.', 'info');
        }else{
          const worksheet = XLSX.utils.json_to_sheet(bluexData);
          workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Datos Bluexpress');
        }

        updateProgress(90,'Preparando descarga...');
        const now = new Date();
        const timestamp = now.toISOString().slice(0,19).replace(/[:T]/g,'_').replace(/-/g,'');
        const fileName = `bluexpress_carga_${timestamp}.xlsx`;

        XLSX.writeFile(workbook, fileName, { bookType:'xlsx', bookSST:true, cellStyles:true, cellDates:true });

        updateProgress(100,'¬°Completado!');
        showAlert(`¬°Archivo generado! üìä ${fileName}`, 'success');
        showAlert(`Se procesaron ${bluexData.length} pedidos correctamente.`, 'success');
      }catch(error){
        console.error('Error al generar archivo:', error);
        showAlert(`Error al procesar el archivo: ${error.message}`, 'error');
        resetProgress();
      }finally{
        elements.generateBtn.disabled = false;
        elements.generateBtn.classList.remove('loading');
      }
    }

    // =========================
    // 10) Reset del formulario
    // =========================
    function resetForm(){
      // archivos
      ['csvFile','templateFile'].forEach(id => {
        const input = document.getElementById(id);
        if(input){ input.value=''; }
        const label = document.querySelector(`label[for="${id}"]`);
        const fileText = label?.querySelector('.file-text');
        if(label){ label.classList.remove('has-file','processing'); }
        if(fileText){
          fileText.textContent = id==='csvFile' ? 'Seleccionar archivo CSV de Shopify' : 'Seleccionar plantilla oficial';
        }
      });
      elements.csvFileInfo.classList.remove('visible');
      elements.templateFileInfo.classList.remove('visible');

      // switches
      elements.useTemplate.checked = false;
      elements.templateGroup.classList.add('hidden');

      // configuraci√≥n por defecto
      setUIFromConfig({
        valor_contenido_col:'Subtotal',
        telefono_prefijo_pais:'56',
        defaults:{'Tipo Entrega*':'Domicilio','Garant√≠a*':'No','Tama√±o*':'M'},
        max_desc_len:180,
        normalize:{'Regi√≥n*':{},'Comuna*':{}}
      });

      clearAlerts();
      resetProgress();
      showAlert('Formulario reiniciado.', 'info');
    }
  </script>
</body>
</html>
